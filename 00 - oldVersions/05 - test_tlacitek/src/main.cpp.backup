#include <Arduino.h>
#include <TFT_eSPI.h>
#include <FS.h>
#include <LittleFS.h>
#include <Preferences.h>

// === Glob√°ln√≠ objekty ===
TFT_eSPI tft = TFT_eSPI();
Preferences prefs;

// === Glob√°ln√≠ promƒõnn√© ===
volatile bool actionInProgress = false;
volatile int selectedAction = 0;
volatile bool needsRedraw = false;
const int ACTION_COUNT = 6;

int hunger = 100;
int sleepiness = 100;
int hygiene = 100;
int health = 100;
bool sick = false;

unsigned long lastDecay = 0;
const unsigned long decayInterval = 10000;

unsigned long lastIllCheck = 0;
unsigned long nextIllTime = 60000;

const char* actionNames[] = {"EAT", "SLEEP", "BATH", "PLAY", "HEAL", "INFO"};
const char* actionShort[] = {"E", "S", "B", "P", "H", "I"};

// === Include hlaviƒçkov√Ωch soubor≈Ø ===
#include "buttons.h"
#include "display.h"
#include "pet.h"

// === Setup ===
void setup() {
  Serial.begin(115200);
  delay(500);
  Serial.println("\n\nüêæ Tamagotchi Start!");
  Serial.println("========================\n");
  
  // Inicializace displeje
  initDisplay();
  showLoading();
  
  // Inicializace LittleFS
  if (!LittleFS.begin()) {
    Serial.println("‚ùå LittleFS FAIL");
    showError("FS ERROR!");
    while (1);
  }
  Serial.println("‚úÖ LittleFS OK");
  
  // Inicializace tlaƒç√≠tek
  initButtons();
  
  // Naƒçten√≠ ulo≈æen√©ho stavu
  loadState();
  
  // Random seed
  randomSeed(analogRead(0));
  
  // Prvn√≠ zobrazen√≠
  drawIdle();
  drawMenu();
  
  Serial.println("\n========================");
  Serial.println("‚úÖ V≈°e p≈ôipraveno!");
  Serial.println("üéÆ Stiskni tlaƒç√≠tka...\n");
}

// === Main Loop ===
void loop() {
  // Debug ka≈æd√Ωch 5 sekund
  static unsigned long lastDebug = 0;
  if (millis() - lastDebug > 5000) {
    lastDebug = millis();
    debugButtons();
  }
  
  // Decay stav≈Ø
  updateDecay();
  
  // Kontrola nemoci
  checkIllness();
  
  // P≈ôekreslit menu pokud pot≈ôeba
  if (needsRedraw) {
    needsRedraw = false;
    drawMenu();
  }
  
  // Prov√©st akci
  if (actionInProgress) {
    executeAction(selectedAction);
    actionInProgress = false;
    needsRedraw = true;
  }
  
  delay(10);
}